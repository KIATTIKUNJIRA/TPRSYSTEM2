(function(){const $=(s,e=document)=>e.querySelector(s);const $$=(s,e=document)=>[...e.querySelectorAll(s)];const params=new URLSearchParams(location.search);const fmt=(d)=>new Date(d).toLocaleDateString('th-TH',{day:'2-digit',month:'short'});const DATA=window.TPRGS_DATA;const PEOPLE=DATA.PEOPLE;const STATUS=DATA.STATUS;const boards=DATA.boards;function person(id){return PEOPLE.find(p=>p.id===id)||{name:'ไม่ระบุ'};}function statusMeta(k){return STATUS.find(s=>s.key===k)||STATUS[0];}function getBoard(){const id=params.get('id');return boards.find(b=>b.id===id)||boards[0];}function getTask(board){const tid=params.get('task');for(const g of board.groups){const it=g.items.find(i=>i.id===tid);if(it)return it;}return null;}function header(active){const b=getBoard();return `<div class="header"><div class="wrap"><div class="brand"><div class="logo">TP</div><div class="title"><strong>TPRGS Project Suite</strong><small>mockup • ไทย • ขาว/พาสเทล</small></div></div><nav class="nav"><a href="index.html" class="${active==='home'?'active':''}">หน้าแรก</a><a href="board.html?id=${b.id}" class="${active==='board'?'active':''}">บอร์ด</a><a href="kanban.html?id=${b.id}" class="${active==='kanban'?'active':''}">คัมบัง</a><a href="gantt.html?id=${b.id}" class="${active==='gantt'?'active':''}">ไทม์ไลน์</a><a href="calendar.html?id=${b.id}" class="${active==='calendar'?'active':''}">ปฏิทิน</a><a href="workload.html?id=${b.id}" class="${active==='workload'?'active':''}">ภาระงาน</a><a href="charts.html?id=${b.id}" class="${active==='charts'?'active':''}">แผนภูมิ</a><a href="time.html?id=${b.id}" class="${active==='time'?'active':''}">เวลา</a><a href="automations.html?id=${b.id}" class="${active==='auto'?'active':''}">อัตโนมัติ</a><a href="dashboard.html" class="${active==='dash'?'active':''}">แดชบอร์ด</a><a href="integrations.html" class="${active==='int'?'active':''}">Integrations</a><a href="share.html?id=${b.id}" class="${active==='share'?'active':''}">แชร์</a><a href="settings.html?id=${b.id}" class="${active==='settings'?'active':''}">ตั้งค่า</a></nav></div></div>`;}function renderHome(){const el=$('#content');let html='<div class="row">';for(const b of boards){html+=`<div class="card" style="flex:1 1 360px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><div style="font-weight:600">${b.name}</div><div class="hint">${b.description||''}</div></div><a class="btn-link" href="board.html?id=${b.id}">เปิดบอร์ด →</a></div><hr/><div class="hint">งานทั้งหมด: ${b.groups.reduce((n,g)=>n+g.items.length,0)}</div><div style="display:flex;gap:6px;margin-top:8px">${STATUS.map(s=>{const n=b.groups.flatMap(g=>g.items).filter(i=>i.status===s.key).length;return `<span class="badge ${s.cls}">${s.label} ${n}</span>`;}).join('')}</div></div>`;}html+='</div>';el.innerHTML=html;}function renderBoard(){const b=getBoard();const el=$('#content');if(!b.groups.length){el.innerHTML='<div class="card">ยังไม่มีกลุ่มในบอร์ดนี้</div>';return;}el.innerHTML=b.groups.map(g=>`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">${g.name}</div><button class="btn secondary" data-add="${g.id}">เพิ่มงาน</button></div><div style="overflow:auto;margin-top:8px"><table class="table"><thead><tr><th>งาน</th><th>สถานะ</th><th>ผู้รับผิดชอบ</th><th>เส้นเวลา</th><th>กำหนดส่ง</th><th>เพิ่มเติม</th></tr></thead><tbody>${g.items.map(it=>`<tr><td><a href="task.html?id=${b.id}&task=${it.id}" class="btn-link">${it.title}</a></td><td><span class="badge ${statusMeta(it.status).cls}">${statusMeta(it.status).label}</span></td><td>${person(it.assignee).name}</td><td class="hint">${fmt(it.start)} – ${fmt(it.end)}</td><td>${fmt(it.due)}</td><td class="hint">ไฟล์ ${it.files||0} • คอมเมนต์ ${it.comments||0}</td></tr>`).join('')}</tbody></table></div></div>`).join('');$$("#content [data-add]").forEach(btn=>btn.addEventListener('click',(e)=>{const gid=e.currentTarget.getAttribute('data-add');const name=prompt('ชื่องานใหม่');if(!name)return;const g=b.groups.find(x=>x.id===gid);g.items.unshift({id:'t'+Math.random().toString(36).slice(2,7),title:name,assignee:'u1',status:'todo',start:new Date(),end:new Date(),due:new Date(),priority:'med',estimate:2,spent:0,files:0,comments:0});renderBoard();}));}function renderKanban(){const b=getBoard();const items=b.groups.flatMap(g=>g.items);const cols=STATUS.map(s=>s.key);const el=$('#content');el.innerHTML='<div class="kgrid"></div>';const grid=$('.kgrid');for(const col of cols){const s=statusMeta(col);const box=document.createElement('div');box.className='kcol';box.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span class="badge ${s.cls}">${s.label}</span></div>`;box.addEventListener('dragover',e=>e.preventDefault());box.addEventListener('drop',e=>{const id=e.dataTransfer.getData('id');for(const g of b.groups){const it=g.items.find(x=>x.id===id);if(it){it.status=col;break;}}renderKanban();});const list=document.createElement('div');for(const it of items.filter(i=>i.status===col)){const card=document.createElement('div');card.className='kcard';card.draggable=true;card.addEventListener('dragstart',e=>e.dataTransfer.setData('id',it.id));card.innerHTML=`<div style="font-weight:600;margin-bottom:4px">${it.title}</div><div class="hint">${person(it.assignee).name} • ${fmt(it.due)}</div>`;card.onclick=()=>location.href=`task.html?id=${b.id}&task=${it.id}`;list.appendChild(card);}box.appendChild(list);grid.appendChild(box);}}function renderGantt(){const b=getBoard();const items=b.groups.flatMap(g=>g.items);if(!items.length){$('#content').innerHTML='<div class="card">ยังไม่มีงานในบอร์ดนี้</div>';return;}const min=Math.min(...items.map(i=>+new Date(i.start)));const max=Math.max(...items.map(i=>+new Date(i.end)));const days=Math.max(1,Math.ceil((max-min)/86400000)+1);const rows=items.map(it=>{const startOffset=Math.max(0,Math.floor((+new Date(it.start)-min)/86400000));const span=Math.max(1,Math.ceil((+new Date(it.end)-(+new Date(it.start)))/86400000)+1);return{it,startOffset,span};});let html=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ไทม์ไลน์</div>`;html+=`<div style="display:grid;grid-template-columns:240px repeat(${days},1fr);font-size:12px">`;html+=`<div class="hint">งาน</div>`;for(let i=0;i<days;i++){const d=new Date(min+i*86400000);html+=`<div class="hint" style="text-align:center">${d.toLocaleDateString('th-TH',{day:'2-digit'})}</div>`;}for(const r of rows){html+=`<div style="border-top:1px solid var(--line);padding:8px 6px">${r.it.title}</div>`;html+=`<div style="position:relative;border-top:1px solid var(--line);height:36px"><div class="badge ${statusMeta(r.it.status).cls}" style="position:absolute;height:22px;left:calc(${r.startOffset}/${days} * 100%);width:calc(${r.span}/${days} * 100%);display:flex;align-items:center;justify-content:center">${person(r.it.assignee).name}</div></div>`;}html+=`</div></div>`;$('#content').innerHTML=html;}function renderCalendar(){const b=getBoard();const items=b.groups.flatMap(g=>g.items);const now=new Date();const monthStart=new Date(now.getFullYear(),now.getMonth(),1);const monthEnd=new Date(now.getFullYear(),now.getMonth()+1,0);const startDay=monthStart.getDay();const total=startDay+monthEnd.getDate();let html=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ปฏิทิน – ${now.toLocaleDateString('th-TH',{month:'long',year:'numeric'})}</div>`;html+=`<div class="grid-7" style="font-size:12px;color:var(--muted);margin-bottom:6px"><div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div></div>`;html+=`<div class="grid-7">`;for(let i=0;i<total;i++){const day=i-startDay+1;const inMonth=day>=1&&day<=monthEnd.getDate();const date=inMonth?new Date(now.getFullYear(),now.getMonth(),day):null;const tasks=date?items.filter(t=>new Date(t.due).toDateString()===date.toDateString()):[];html+=`<div class="day"><div class="hint" style="margin-bottom:4px">${inMonth?day:''}</div>`;for(const t of tasks){html+=`<a class="btn-link" href="task.html?id=${b.id}&task=${t.id}"><span class="badge ${statusMeta(t.status).cls}">${t.title}</span></a><br/>`;}html+=`</div>`;}html+=`</div></div>`;$('#content').innerHTML=html;}function renderWorkload(){const b=getBoard();const items=b.groups.flatMap(g=>g.items).filter(i=>i.status!=='done');const map=new Map();for(const it of items){map.set(it.assignee,(map.get(it.assignee)||0)+(it.estimate||1));}const rows=DATA.PEOPLE.map(p=>({p,hours:map.get(p.id)||0}));const max=Math.max(1,...rows.map(r=>r.hours));let html=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ภาระงานตามคน (ชั่วโมงประมาณการ)</div>`;for(const r of rows){html+=`<div style="margin:10px 0">${r.p.name} <span class="hint">${r.hours} ชม.</span><div class="progress"><div class="bar" style="width:${(r.hours/max)*100}%"></div></div></div>`;}html+=`</div>`;$('#content').innerHTML=html;}function renderCharts(){const b=getBoard();const items=b.groups.flatMap(g=>g.items);const counts=STATUS.map(s=>({s,n:items.filter(i=>i.status===s.key).length}));const max=Math.max(1,...counts.map(x=>x.n));let html=`<div class="row">`;html+=`<div class="card" style="flex:1 1 360px"><div style="font-weight:600;margin-bottom:8px">จำนวนงานตามสถานะ</div>`;for(const c of counts){html+=`<div style="margin:8px 0"><div class="hint">${c.s.label} – ${c.n}</div><div class="progress"><div class="bar" style="width:${(c.n/max)*100}%"></div></div></div>`;}html+=`</div>`;const done=items.filter(i=>i.status==='done').length;const pct=Math.round((done/Math.max(1,items.length))*100);html+=`<div class="card" style="flex:1 1 360px"><div style="font-weight:600;margin-bottom:8px">ความคืบหน้าโครงการ</div><div class="progress"><div class="bar" style="width:${pct}%;background:var(--ok)"></div></div><div class="hint" style="margin-top:6px">${pct}% ของงานทั้งหมด</div></div>`;html+=`</div>`;$('#content').innerHTML=html;}function renderTime(){const b=getBoard();const items=b.groups.flatMap(g=>g.items);let html=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ติดตามเวลา (Mock)</div>`;for(const t of items){html+=`<div class="card" style="padding:12px;margin-top:8px"><div style="display:flex;align-items:center;justify-content:space-between"><div><div style="font-weight:600">${t.title}</div><div class="hint">ผู้รับผิดชอบ: ${person(t.assignee).name}</div></div><div><button class="btn secondary">เริ่ม</button></div></div></div>`;}html+=`</div>`;$('#content').innerHTML=html;}function renderAutomations(){const b=getBoard();const rules=[{when:'เมื่อสถานะเปลี่ยนเป็น เสร็จสิ้น',then:'ย้ายไปกลุ่ม “เสร็จแล้ว”'},{when:'เมื่อสร้างงานใหม่',then:'แจ้งผู้จัดการโครงการ'},{when:'ก่อนกำหนดส่ง 1 วัน',then:'แจ้งผู้รับผิดชอบ'},];let html=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ตัวสร้างระบบอัตโนมัติ (Mock)</div>`;for(const r of rules){html+=`<div class="card" style="padding:12px"><div class="hint">WHEN</div><div style="font-weight:600">${r.when}</div><hr/><div class="hint">THEN</div><div style="font-weight:600">${r.then}</div></div>`;}html+=`</div>`;$('#content').innerHTML=html;}function renderDashboard(){const totalBoards=boards.length;const totalTasks=boards.reduce((n,b)=>n+b.groups.reduce((m,g)=>m+g.items.length,0),0);let html=`<div class="row">`;html+=`<div class="card" style="flex:1 1 320px"><div class="hint">จำนวนบอร์ด</div><div style="font-weight:700;font-size:28px">${totalBoards}</div></div>`;html+=`<div class="card" style="flex:1 1 320px"><div class="hint">จำนวนงานทั้งหมด</div><div style="font-weight:700;font-size:28px">${totalTasks}</div></div>`;html+=`<div class="card" style="flex:2 1 480px"><div style="font-weight:600;margin-bottom:8px">บอร์ดยอดนิยม</div>`;for(const b of boards){html+=`<div style="margin:6px 0"><a class="btn-link" href="board.html?id=${b.id}">${b.name}</a> <span class="hint">(${b.groups.reduce((n,g)=>n+g.items.length,0)} งาน)</span></div>`;}html+=`</div></div>`;$('#content').innerHTML=html;}function renderTask(){const b=getBoard();const t=getTask(b);if(!t){$('#content').innerHTML='<div class="card">ไม่พบนงานที่ต้องการ</div>';return;}$('#content').innerHTML=`<div class="card"><div style="font-weight:700;font-size:18px;margin-bottom:6px">${t.title}</div><div class="form-row"><div><div class="hint">ผู้รับผิดชอบ</div><div>${person(t.assignee).name}</div></div><div><div class="hint">สถานะ</div><span class="badge ${statusMeta(t.status).cls}">${statusMeta(t.status).label}</span></div><div><div class="hint">เส้นเวลา</div><div>${fmt(t.start)} – ${fmt(t.end)}</div></div><div><div class="hint">กำหนดส่ง</div><div>${fmt(t.due)}</div></div></div><hr/><div class="hint">ไฟล์แนบ ${t.files||0} • คอมเมนต์ ${t.comments||0}</div></div>`;}function renderShare(){const b=getBoard();$('#content').innerHTML=`<div class="card"><div style="font-weight:600;margin-bottom:8px">แชร์บอร์ด: ${b.name}</div><div class="form-row"><input placeholder="อีเมลผู้รับเชิญ"/><select><option>ดูอย่างเดียว</option><option>แก้ไขได้</option></select></div><div style="margin-top:12px"><button class="btn">ส่งคำเชิญ</button></div><hr/><div class="hint">ลิงก์แบบสาธารณะ (mock):</div><input value="https://tprgs.com/boards/${b.id}" style="width:100%"/></div>`;}function renderIntegrations(){$('#content').innerHTML=`<div class="card"><div style="font-weight:600;margin-bottom:8px">Integrations Hub</div><div class="row"><div class="card" style="flex:1 1 280px"><div style="font-weight:600">Slack</div><div class="hint">แจ้งเตือนอัปเดต</div><button class="btn" style="margin-top:8px">เชื่อมต่อ</button></div><div class="card" style="flex:1 1 280px"><div style="font-weight:600">Google Drive</div><div class="hint">แนบไฟล์จากไดรฟ์</div><button class="btn" style="margin-top:8px">เชื่อมต่อ</button></div><div class="card" style="flex:1 1 280px"><div style="font-weight:600">Calendar</div><div class="hint">ซิงก์กำหนดการ</div><button class="btn" style="margin-top:8px">เชื่อมต่อ</button></div></div></div>`;}function renderSettings(){const b=getBoard();$('#content').innerHTML=`<div class="card"><div style="font-weight:600;margin-bottom:8px">ตั้งค่าบอร์ด: ${b.name}</div><div class="form-row"><input placeholder="ชื่อบอร์ด" value="${b.name}"/><select><option>สิทธิ์: ทีม</option><option>สาธารณะ</option></select></div><div style="margin-top:12px"><button class="btn">บันทึก</button> <button class="btn secondary">ยกเลิก</button></div></div>`;}function init(pageKey){document.body.insertAdjacentHTML('afterbegin',header(pageKey));const footer=document.createElement('footer');footer.textContent='© '+(new Date()).getFullYear()+' TPRGS.COM – mockup';document.body.appendChild(footer);const map={'home':renderHome,'board':renderBoard,'kanban':renderKanban,'gantt':renderGantt,'calendar':renderCalendar,'workload':renderWorkload,'charts':renderCharts,'time':renderTime,'auto':renderAutomations,'dash':renderDashboard,'task':renderTask,'share':renderShare,'int':renderIntegrations,'settings':renderSettings,};map[pageKey]&&map[pageKey]();}window.TPRGS={init};})();