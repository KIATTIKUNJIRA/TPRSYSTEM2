<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign Up - TPRSYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="assets/main.css" rel="stylesheet">
</head>

<body class="bg-slate-50 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-slate-800">Create an account</h1>
        <p class="text-sm text-center text-slate-500 mt-1">Register a new user</p>

        <form id="signup-form" class="mt-8 space-y-4" novalidate>
            <div>
                <label for="email" class="text-sm font-medium text-slate-700">Email</label>
                <input type="email" id="email" required class="mt-1 w-full border border-slate-300 rounded-xl px-3 py-2"
                    placeholder="you@example.com">
            </div>

            <div>
                <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                <input type="password" id="password" required
                    class="mt-1 w-full border border-slate-300 rounded-xl px-3 py-2" placeholder="••••••••">
            </div>

            <div>
                <label for="confirm" class="text-sm font-medium text-slate-700">Confirm password</label>
                <input type="password" id="confirm" required
                    class="mt-1 w-full border border-slate-300 rounded-xl px-3 py-2" placeholder="••••••••">
            </div>

            <div id="message" class="text-sm h-6"></div>

            <button type="submit" id="signup-button"
                class="w-full bg-emerald-600 text-white rounded-xl py-2 font-semibold flex items-center justify-center">
                <span id="signup-button-text">Create account</span>
            </button>
        </form>

        <p class="text-center text-sm mt-2">
            Already have an account? <a href="/login.html" class="text-blue-600 hover:underline">Sign in</a>
        </p>

    </div>

    <script type="module" src="assets/env.js"></script>
    <script type="module">
        (function () {
            const signupForm = document.getElementById('signup-form');
            const messageEl = document.getElementById('message');
            const signupButton = document.getElementById('signup-button');
            const signupButtonText = document.getElementById('signup-button-text');

            function setMessage(text, type) {
                messageEl.textContent = text || '';
                messageEl.className = 'text-sm h-6 ' + (type === 'error' ? 'text-red-600' : 'text-green-600');
            }

            async function getClient() {
                if (window.supabaseClient) return window.supabaseClient;
                try {
                    const mod = await import('./assets/supabase-client.js');
                    const client = mod.supabase || mod.default;
                    if (client) window.supabaseClient = client;
                    return client;
                } catch (err) {
                    console.error('Failed to load supabase client:', err);
                    return null;
                }
            }

            signupForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                setMessage('', '');
                signupButton.disabled = true;
                signupButtonText.textContent = 'Creating...';

                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    setMessage('Please enter email and password.', 'error');
                    signupButton.disabled = false;
                    signupButtonText.textContent = 'Create account';
                    return;
                }

                const confirm = document.getElementById('confirm').value;
                if (password !== confirm) {
                    setMessage('Passwords do not match.', 'error');
                    signupButton.disabled = false;
                    signupButtonText.textContent = 'Create account';
                    return;
                }

                const client = await getClient();
                if (!client) {
                    setMessage('Unable to initialize authentication client.', 'error');
                    signupButton.disabled = false;
                    signupButtonText.textContent = 'Create account';
                    return;
                }

                try {
                    const { data, error } = await client.auth.signUp({ email, password });
                    if (error) {
                        console.error('Signup error:', error);
                        setMessage(error.message || 'Signup failed', 'error');
                        signupButton.disabled = false;
                        signupButtonText.textContent = 'Create account';
                        return;
                    }

                    console.log('Signup success', data);
                    setMessage('Account created. Please check your email to confirm (if required). Redirecting to login...', 'success');
                    setTimeout(() => { window.location.href = '/login.html'; }, 800);

                } catch (err) {
                    console.error('Unexpected error during sign-up:', err);
                    setMessage(err.message || 'Unexpected error', 'error');
                    signupButton.disabled = false;
                    signupButtonText.textContent = 'Create account';
                }
            });
        })();
    </script>
</body>

</html>
