import React, { useMemo, useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  LayoutGrid,
  KanbanSquare,
  GanttChart,
  Calendar as CalendarIcon,
  BarChart3,
  Users,
  Clock,
  Settings,
  Plus,
  ChevronRight,
  ChevronLeft,
  Download,
  Play,
  Pause,
  MessageSquare,
  Paperclip,
  CheckCircle2,
} from "lucide-react";

// ──────────────────────────────────────────────────────────────────────────────
// TPRGS Project Suite – Single‑file, interactive Hi‑Fi mockup (Thai UI)
// Style: white / soft pastel accents; lightweight, no backend – mock data only.
// ──────────────────────────────────────────────────────────────────────────────

const pastel = {
  brand: "#0ea5e9", // sky-500
  accent: "#a78bfa", // violet-400
  ok: "#22c55e",
  warn: "#f59e0b",
  danger: "#ef4444",
  bg: "#f9fafb",
  panel: "#ffffff",
  line: "#e5e7eb",
};

const PEOPLE = [
  { id: "u1", name: "กิรติคุณ", email: "kiattikun@tprgs.com" },
  { id: "u2", name: "ศศิธร", email: "sasitorn@tprgs.com" },
  { id: "u3", name: "ธนวัต", email: "thanawat@tprgs.com" },
  { id: "u4", name: "มยุรี", email: "mayuree@tprgs.com" },
];

const STATUS = [
  { key: "todo", label: "ยังไม่เริ่ม", color: "#94a3b8" },
  { key: "doing", label: "กำลังทำ", color: pastel.accent },
  { key: "review", label: "รอตรวจ", color: "#fb923c" },
  { key: "done", label: "เสร็จสิ้น", color: pastel.ok },
];

const PRIORITY = {
  low: { label: "ต่ำ", color: "#A7F3D0" },
  med: { label: "กลาง", color: "#FEF9C3" },
  high: { label: "สูง", color: "#FECACA" },
};

const sampleBoards = [
  {
    id: "b1",
    name: "TPRGS – Site Revamp",
    description: "ปรับโฉมเว็บไซต์บริษัทและศูนย์ข้อมูล",
    groups: [
      {
        id: "g1",
        name: "สัปดาห์นี้",
        items: [
          {
            id: "t1",
            title: "วางโครงหน้า Landing Page",
            assignee: "u2",
            status: "doing",
            priority: "high",
            start: addDays(new Date(), -2),
            end: addDays(new Date(), 5),
            due: addDays(new Date(), 6),
            estimate: 10,
            spent: 4,
            deps: [],
            comments: [
              { by: "u1", text: "รอรูปจากฝ่ายการตลาด", at: new Date() },
            ],
            files: 1,
          },
          {
            id: "t2",
            title: "เชื่อมต่อแบบฟอร์มติดต่อ",
            assignee: "u3",
            status: "todo",
            priority: "med",
            start: addDays(new Date(), 1),
            end: addDays(new Date(), 6),
            due: addDays(new Date(), 6),
            estimate: 6,
            spent: 0,
            deps: ["t1"],
            comments: [],
            files: 0,
          },
        ],
      },
      {
        id: "g2",
        name: "Backlog",
        items: [
          {
            id: "t3",
            title: "ตั้งค่า SEO ขั้นพื้นฐาน",
            assignee: "u4",
            status: "todo",
            priority: "low",
            start: addDays(new Date(), 7),
            end: addDays(new Date(), 12),
            due: addDays(new Date(), 12),
            estimate: 5,
            spent: 0,
            deps: [],
            comments: [],
            files: 0,
          },
        ],
      },
      {
        id: "g3",
        name: "เสร็จแล้ว",
        items: [
          {
            id: "t4",
            title: "ออกแบบโลโก้ย่อย TPRGS Labs",
            assignee: "u1",
            status: "done",
            priority: "med",
            start: addDays(new Date(), -10),
            end: addDays(new Date(), -4),
            due: addDays(new Date(), -4),
            estimate: 4,
            spent: 5,
            deps: [],
            comments: [],
            files: 2,
          },
        ],
      },
    ],
  },
  {
    id: "b2",
    name: "Mobile App – CRM",
    description: "แอป CRM สำหรับฝ่ายขาย",
    groups: [],
  },
];

const VIEWS = [
  { key: "board", label: "บอร์ด", icon: LayoutGrid },
  { key: "kanban", label: "คัมบัง", icon: KanbanSquare },
  { key: "gantt", label: "ไทม์ไลน์", icon: GanttChart },
  { key: "calendar", label: "ปฏิทิน", icon: CalendarIcon },
  { key: "workload", label: "ภาระงาน", icon: Users },
  { key: "charts", label: "แผนภูมิ", icon: BarChart3 },
  { key: "time", label: "เวลา", icon: Clock },
  { key: "auto", label: "อัตโนมัติ", icon: Settings },
];

// ──────────────────────────────────────────────────────────────────────────────
// Utilities
function addDays(d, n) {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}
const fmt = (d) => new Date(d).toLocaleDateString("th-TH", { day: "2-digit", month: "short" });

function useLocalState(key, init) {
  const [val, setVal] = useState(() => {
    try { return JSON.parse(localStorage.getItem(key) || "null") ?? init; } catch { return init; }
  });
  useEffect(() => { localStorage.setItem(key, JSON.stringify(val)); }, [key, val]);
  return [val, setVal];
}

const byId = (arr, id) => arr.find((x) => x.id === id);
const person = (id) => PEOPLE.find((p) => p.id === id) || { name: "ไม่ระบุ" };
const statusMeta = (key) => STATUS.find((s) => s.key === key) || STATUS[0];

// ──────────────────────────────────────────────────────────────────────────────
// Root App
export default function App() {
  const [boards, setBoards] = useLocalState("tprgs.boards", sampleBoards);
  const [activeBoardId, setActiveBoardId] = useLocalState("tprgs.activeBoard", boards[0].id);
  const [view, setView] = useLocalState("tprgs.view", "board");
  const [selectedItem, setSelectedItem] = useState(null);
  const activeBoard = useMemo(() => byId(boards, activeBoardId) || boards[0], [boards, activeBoardId]);

  function mutateBoard(updater) {
    setBoards((prev) => prev.map((b) => (b.id === activeBoard.id ? updater({ ...b }) : b)));
  }

  function addTask(groupId) {
    const title = prompt("ชื่องานใหม่");
    if (!title) return;
    mutateBoard((b) => {
      const g = b.groups.find((x) => x.id === groupId);
      g.items.unshift({
        id: "t" + Math.random().toString(36).slice(2, 7),
        title,
        assignee: PEOPLE[0].id,
        status: "todo",
        priority: "med",
        start: new Date(),
        end: addDays(new Date(), 3),
        due: addDays(new Date(), 3),
        estimate: 3,
        spent: 0,
        deps: [],
        comments: [],
        files: 0,
      });
      return b;
    });
  }

  function moveTask(itemId, toStatus) {
    mutateBoard((b) => {
      for (const g of b.groups) {
        const idx = g.items.findIndex((it) => it.id === itemId);
        if (idx >= 0) {
          g.items[idx].status = toStatus;
        }
      }
      return b;
    });
  }

  function exportHTML() {
    const data = { boards, activeBoardId, view };
    const html = makeStandaloneHTML(data);
    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "tprgs-project-suite-mockup.html";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  return (
    <div style={{ background: pastel.bg, minHeight: "100vh" }}>
      <TopBar view={view} setView={setView} exportHTML={exportHTML} />

      <div className="mx-auto max-w-7xl px-4 py-6 grid grid-cols-12 gap-6">
        <aside className="col-span-12 lg:col-span-3">
          <Sidebar boards={boards} active={activeBoardId} onPick={setActiveBoardId} setBoards={setBoards} />
        </aside>

        <main className="col-span-12 lg:col-span-9">
          {view === "board" && (
            <BoardView board={activeBoard} onAddTask={addTask} onOpenItem={setSelectedItem} />
          )}
          {view === "kanban" && (
            <KanbanView board={activeBoard} onDrop={(id, s) => moveTask(id, s)} onOpenItem={setSelectedItem} />
          )}
          {view === "gantt" && <GanttView board={activeBoard} />}
          {view === "calendar" && <CalendarView board={activeBoard} onOpenItem={setSelectedItem} />}
          {view === "workload" && <WorkloadView board={activeBoard} />}
          {view === "charts" && <ChartsView board={activeBoard} />}
          {view === "time" && <TimeView board={activeBoard} />}
          {view === "auto" && <AutomationView board={activeBoard} />}
        </main>
      </div>

      <ItemDrawer item={selectedItem} onClose={() => setSelectedItem(null)} mutateBoard={mutateBoard} />
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function TopBar({ view, setView, exportHTML }) {
  return (
    <div className="sticky top-0 z-40 border-b" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="h-9 w-9 rounded-xl flex items-center justify-center font-bold text-white" style={{ background: pastel.brand }}>TP</div>
          <div className="leading-tight">
            <div className="font-semibold">TPRGS Project Suite</div>
            <div className="text-xs text-gray-500">mockup – ไทย • สีขาว/พาสเทล • คลิกสลับมุมมองได้</div>
          </div>
        </div>

        <div className="flex items-center gap-2 overflow-x-auto">
          {VIEWS.map((v) => (
            <button
              key={v.key}
              onClick={() => setView(v.key)}
              className={`flex items-center gap-2 px-3 py-2 rounded-xl text-sm whitespace-nowrap transition ${
                view === v.key ? "text-white" : "text-gray-700 hover:bg-gray-100"
              }`}
              style={{ background: view === v.key ? pastel.brand : "transparent" }}
              title={v.label}
            >
              <v.icon size={18} /> {v.label}
            </button>
          ))}
          <button
            onClick={exportHTML}
            className="ml-2 flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-gray-700 hover:bg-gray-100"
            title="บันทึกเป็นไฟล์ HTML สำหรับอัปขึ้นออนไลน์"
          >
            <Download size={18} /> บันทึกเป็น HTML
          </button>
        </div>
      </div>
    </div>
  );
}

function Sidebar({ boards, active, onPick, setBoards }) {
  return (
    <div className="rounded-2xl border p-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="flex items-center gap-2 mb-3"><LayoutGrid size={18} /> <span className="font-semibold">บอร์ดของฉัน</span></div>
      <div className="space-y-2">
        {boards.map((b) => (
          <button
            key={b.id}
            onClick={() => onPick(b.id)}
            className={`w-full text-left px-3 py-2 rounded-xl transition ${
              active === b.id ? "bg-gray-100" : "hover:bg-gray-50"
            }`}
          >
            <div className="font-medium">{b.name}</div>
            <div className="text-xs text-gray-500 line-clamp-1">{b.description || "—"}</div>
          </button>
        ))}
      </div>

      <hr className="my-4" />
      <button
        onClick={() => {
          const name = prompt("ชื่อบอร์ดใหม่");
          if (!name) return;
          setBoards((prev) => [
            ...prev,
            { id: "b" + Math.random().toString(36).slice(2, 6), name, description: "", groups: [] },
          ]);
        }}
        className="w-full flex items-center justify-center gap-2 bg-gray-900 text-white rounded-xl py-2"
      >
        <Plus size={18} /> สร้างบอร์ดใหม่
      </button>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function BoardView({ board, onAddTask, onOpenItem }) {
  if (!board?.groups?.length) return <EmptyState title="ยังไม่มีงานในบอร์ดนี้" subtitle="เพิ่มกลุ่มและรายการงานเพื่อเริ่มต้น" />;
  return (
    <div className="space-y-6">
      {board.groups.map((g) => (
        <div key={g.id} className="rounded-2xl border" style={{ background: pastel.panel, borderColor: pastel.line }}>
          <div className="flex items-center justify-between p-4">
            <div className="font-semibold">{g.name}</div>
            <button onClick={() => onAddTask(g.id)} className="px-3 py-1.5 rounded-lg text-sm bg-gray-100 hover:bg-gray-200">เพิ่มงาน</button>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-50">
                <tr className="text-left text-gray-500">
                  <th className="px-4 py-3">งาน</th>
                  <th className="px-4 py-3">สถานะ</th>
                  <th className="px-4 py-3">ผู้รับผิดชอบ</th>
                  <th className="px-4 py-3">เส้นเวลา</th>
                  <th className="px-4 py-3">กำหนดส่ง</th>
                  <th className="px-4 py-3">ความสำคัญ</th>
                  <th className="px-4 py-3 text-right">ไฟล์/คอมเมนต์</th>
                </tr>
              </thead>
              <tbody>
                {g.items.map((it) => (
                  <tr key={it.id} className="border-t hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <button className="font-medium hover:underline" onClick={() => onOpenItem({ ...it, groupId: g.id })}>{it.title}</button>
                    </td>
                    <td className="px-4 py-3"><StatusPill status={it.status} /></td>
                    <td className="px-4 py-3">{person(it.assignee).name}</td>
                    <td className="px-4 py-3 text-gray-600">{fmt(it.start)} – {fmt(it.end)}</td>
                    <td className="px-4 py-3">{fmt(it.due)}</td>
                    <td className="px-4 py-3"><PriorityPill level={it.priority} /></td>
                    <td className="px-4 py-3 text-right text-gray-500 flex items-center gap-3 justify-end">
                      <span className="flex items-center gap-1"><Paperclip size={15} />{it.files}</span>
                      <span className="flex items-center gap-1"><MessageSquare size={15} />{it.comments?.length || 0}</span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      ))}
    </div>
  );
}

function StatusPill({ status }) {
  const s = statusMeta(status);
  return (
    <span className="px-2.5 py-1 rounded-full text-xs text-white" style={{ background: s.color }}>{s.label}</span>
  );
}
function PriorityPill({ level }) {
  const p = PRIORITY[level] || PRIORITY.med;
  return (
    <span className="px-2.5 py-1 rounded-full text-xs border" style={{ background: p.color, borderColor: "transparent" }}>{p.label}</span>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function KanbanView({ board, onDrop, onOpenItem }) {
  const cols = STATUS.map((s) => s.key);
  const items = board.groups.flatMap((g) => g.items);
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {cols.map((col) => (
        <div key={col} className="rounded-2xl border p-3 min-h-[360px]" style={{ background: pastel.panel, borderColor: pastel.line }}
          onDragOver={(e) => e.preventDefault()} onDrop={(e) => onDrop(e.dataTransfer.getData("id"), col)}>
          <div className="flex items-center gap-2 mb-3">
            <div className="h-2 w-2 rounded-full" style={{ background: statusMeta(col).color }} />
            <div className="font-semibold">{statusMeta(col).label}</div>
          </div>
          <div className="space-y-3">
            {items.filter((i) => i.status === col).map((it) => (
              <motion.div key={it.id} layout drag onDragStart={(e) => e.dataTransfer.setData("id", it.id)}
                className="rounded-xl border p-3 cursor-grab bg-white"
                onClick={() => onOpenItem({ ...it })}
                whileHover={{ scale: 1.01 }}>
                <div className="font-medium mb-1">{it.title}</div>
                <div className="text-xs text-gray-500 flex items-center gap-2">
                  <span>{person(it.assignee).name}</span>
                  <span>•</span>
                  <span>{fmt(it.due)}</span>
                </div>
              </motion.div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function GanttView({ board }) {
  const items = board.groups.flatMap((g) => g.items);
  if (!items.length) return <EmptyState title="ยังไม่มีงาน" subtitle="เพิ่มงานเพื่อแสดงไทม์ไลน์" />;

  const minDate = new Date(Math.min(...items.map((i) => +new Date(i.start))));
  const maxDate = new Date(Math.max(...items.map((i) => +new Date(i.end))));
  const days = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 3600 * 24)) + 1);

  return (
    <div className="rounded-2xl border overflow-hidden" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="p-4 font-semibold">ไทม์ไลน์โครงการ</div>
      <div className="overflow-x-auto">
        <div className="min-w-[720px]">
          <div className="grid" style={{ gridTemplateColumns: `240px repeat(${days}, 1fr)` }}>
            <div className="bg-gray-50 border-b px-3 py-2 text-sm text-gray-500">งาน</div>
            {Array.from({ length: days }).map((_, i) => (
              <div key={i} className="bg-gray-50 border-b text-[10px] text-gray-500 px-1 py-2 text-center">
                {fmt(addDays(minDate, i))}
              </div>
            ))}

            {items.map((it) => {
              const startOffset = Math.max(0, Math.floor((new Date(it.start) - minDate) / 86400000));
              const span = Math.max(1, Math.ceil((new Date(it.end) - new Date(it.start)) / 86400000) + 1);
              return (
                <React.Fragment key={it.id}>
                  <div className="border-t px-3 py-2 text-sm">{it.title}</div>
                  <div className="border-t relative">
                    <div className="h-7 mt-1 relative">
                      <div className="absolute h-6 rounded-full text-white text-xs flex items-center px-2"
                        style={{ left: `calc(${startOffset}/${days}*100%)`, width: `calc(${span}/${days}*100%)`, background: statusMeta(it.status).color }}>
                        {person(it.assignee).name}
                      </div>
                    </div>
                  </div>
                </React.Fragment>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function CalendarView({ board, onOpenItem }) {
  const items = board.groups.flatMap((g) => g.items);
  const today = new Date();
  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
  const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  const startDay = monthStart.getDay();
  const totalCells = startDay + monthEnd.getDate();
  return (
    <div className="rounded-2xl border p-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="font-semibold mb-4">ปฏิทิน – {today.toLocaleDateString("th-TH", { month: "long", year: "numeric" })}</div>
      <div className="grid grid-cols-7 gap-2 text-xs text-gray-500 mb-1">
        {["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"].map((d) => (
          <div key={d} className="text-center">{d}</div>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-2">
        {Array.from({ length: totalCells }).map((_, i) => {
          const day = i - startDay + 1;
          const inMonth = day >= 1 && day <= monthEnd.getDate();
          const date = inMonth ? new Date(today.getFullYear(), today.getMonth(), day) : null;
          const tasks = date
            ? items.filter((it) => new Date(it.due).toDateString() === date.toDateString())
            : [];
          return (
            <div key={i} className={`rounded-xl border p-2 min-h-[92px] ${inMonth ? "bg-white" : "bg-gray-50"}`}
              style={{ borderColor: pastel.line }}>
              <div className="text-[10px] text-gray-500 mb-1">{inMonth ? day : ""}</div>
              <div className="space-y-1">
                {tasks.map((t) => (
                  <button key={t.id} onClick={() => onOpenItem(t)} className="w-full text-left text-[11px] px-2 py-1 rounded-md text-white"
                    style={{ background: statusMeta(t.status).color }}>
                    {t.title}
                  </button>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function WorkloadView({ board }) {
  const items = board.groups.flatMap((g) => g.items).filter((i) => i.status !== "done");
  const map = new Map();
  for (const it of items) {
    const k = it.assignee;
    map.set(k, (map.get(k) || 0) + (it.estimate || 1));
  }
  const rows = PEOPLE.map((p) => ({ person: p, hours: map.get(p.id) || 0 }));
  const max = Math.max(1, ...rows.map((r) => r.hours));

  return (
    <div className="rounded-2xl border p-4 space-y-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="font-semibold">ภาระงานตามคน (ชั่วโมงประมาณการ)</div>
      {rows.map((r) => (
        <div key={r.person.id} className="">
          <div className="text-sm mb-1">{r.person.name} <span className="text-xs text-gray-500">{r.hours} ชม.</span></div>
          <div className="h-3 rounded-full bg-gray-100">
            <div className="h-3 rounded-full" style={{ width: `${(r.hours / max) * 100}%`, background: pastel.brand }} />
          </div>
        </div>
      ))}
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function ChartsView({ board }) {
  const total = board.groups.flatMap((g) => g.items);
  const byStatus = STATUS.map((s) => ({ s: s.key, label: s.label, n: total.filter((i) => i.status === s.key).length }));
  const max = Math.max(1, ...byStatus.map((x) => x.n));
  return (
    <div className="grid gap-4 lg:grid-cols-2">
      <div className="rounded-2xl border p-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
        <div className="font-semibold mb-2">จำนวนงานตามสถานะ</div>
        <div className="space-y-2">
          {byStatus.map((x) => (
            <div key={x.s}>
              <div className="text-sm text-gray-600 mb-1">{x.label} – {x.n}</div>
              <div className="h-3 rounded-full bg-gray-100">
                <div className="h-3 rounded-full" style={{ width: `${(x.n / max) * 100}%`, background: statusMeta(x.s).color }} />
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="rounded-2xl border p-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
        <div className="font-semibold mb-2">ความคืบหน้าโครงการ (ตัวอย่าง)</div>
        <div className="text-sm text-gray-600 mb-3">คิดจากสัดส่วนงานที่เสร็จสิ้น</div>
        <div className="h-4 rounded-full bg-gray-100">
          <div className="h-4 rounded-full text-xs text-white text-center" style={{ width: `${(total.filter((i) => i.status === "done").length / Math.max(1, total.length)) * 100}%`, background: pastel.ok }}>
            {Math.round((total.filter((i) => i.status === "done").length / Math.max(1, total.length)) * 100)}%
          </div>
        </div>
      </div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function TimeView({ board }) {
  const [running, setRunning] = useState(null); // taskId
  const [acc, setAcc] = useState(0);
  useEffect(() => {
    let id;
    if (running) {
      const t0 = Date.now();
      id = setInterval(() => setAcc((v) => v + (Date.now() - t0) / 1000), 1000);
    }
    return () => clearInterval(id);
  }, [running]);
  const all = board.groups.flatMap((g) => g.items);
  return (
    <div className="rounded-2xl border p-4 space-y-3" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="font-semibold">ติดตามเวลา (Mock)</div>
      {all.map((t) => (
        <div key={t.id} className="flex items-center justify-between border rounded-xl px-3 py-2" style={{ borderColor: pastel.line }}>
          <div>
            <div className="font-medium">{t.title}</div>
            <div className="text-xs text-gray-500">ผู้รับผิดชอบ: {person(t.assignee).name}</div>
          </div>
          <div className="flex items-center gap-2">
            <div className="text-sm w-20 text-right">{running === t.id ? formatDuration(acc) : `${t.spent} ชม.`}</div>
            {running === t.id ? (
              <button className="px-3 py-1.5 bg-gray-900 text-white rounded-lg flex items-center gap-1" onClick={() => setRunning(null)}>
                <Pause size={16} /> หยุด
              </button>
            ) : (
              <button className="px-3 py-1.5 bg-gray-100 rounded-lg flex items-center gap-1" onClick={() => setRunning(t.id)}>
                <Play size={16} /> เริ่ม
              </button>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}
function formatDuration(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  return `${h}ชม ${m}นาที`;
}

// ──────────────────────────────────────────────────────────────────────────────
function AutomationView({ board }) {
  const [rules, setRules] = useState([
    { id: "r1", when: "เมื่อสถานะเปลี่ยนเป็น เสร็จสิ้น", then: "ย้ายไปกลุ่ม ‘เสร็จแล้ว’" },
    { id: "r2", when: "เมื่อสร้างงานใหม่", then: "แจ้งผู้จัดการโครงการ" },
    { id: "r3", when: "ก่อนถึงกำหนดส่ง 1 วัน", then: "แจ้งผู้รับผิดชอบ" },
  ]);

  function addRule() {
    const when = prompt("WHEN (trigger): เช่น ‘เมื่อสร้างงานใหม่’");
    if (!when) return;
    const then = prompt("THEN (action): เช่น ‘แจ้งผู้จัดการโครงการ’");
    if (!then) return;
    setRules((r) => [...r, { id: "r" + Date.now(), when, then }]);
  }

  return (
    <div className="rounded-2xl border p-4 space-y-4" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="flex items-center justify-between">
        <div className="font-semibold">ตัวสร้างระบบอัตโนมัติ (Mock)</div>
        <button onClick={addRule} className="px-3 py-1.5 rounded-lg bg-gray-900 text-white flex items-center gap-2"><Plus size={16} /> เพิ่มกติกา</button>
      </div>
      <div className="space-y-2">
        {rules.map((r) => (
          <div key={r.id} className="border rounded-xl p-3 flex items-center justify-between" style={{ borderColor: pastel.line }}>
            <div>
              <div className="text-sm text-gray-500">WHEN</div>
              <div className="font-medium">{r.when}</div>
            </div>
            <ChevronRight className="text-gray-400" />
            <div>
              <div className="text-sm text-gray-500">THEN</div>
              <div className="font-medium">{r.then}</div>
            </div>
          </div>
        ))}
      </div>
      <div className="text-xs text-gray-500">* นี่เป็นเพียงภาพจำลองการตั้งค่าอัตโนมัติสำหรับการเสนอแนวทาง</div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
function ItemDrawer({ item, onClose, mutateBoard }) {
  return (
    <AnimatePresence>
      {item && (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
          className="fixed inset-0 z-50 bg-black/30" onClick={onClose}>
          <motion.div initial={{ x: 420 }} animate={{ x: 0 }} exit={{ x: 420 }}
            transition={{ type: "spring", stiffness: 300, damping: 30 }}
            className="absolute right-0 top-0 h-full w-full max-w-lg bg-white shadow-xl"
            onClick={(e) => e.stopPropagation()}>
            <div className="p-5 border-b flex items-center justify-between">
              <div className="font-semibold pr-4">{item.title}</div>
              <button className="text-gray-500" onClick={onClose}>ปิด</button>
            </div>
            <div className="p-5 space-y-5 text-sm">
              <div className="flex items-center gap-2">
                <span>สถานะ:</span>
                <div className="flex gap-2 flex-wrap">
                  {STATUS.map((s) => (
                    <button key={s.key} className={`px-2.5 py-1 rounded-full text-xs border ${item.status === s.key ? "text-white" : ""}`}
                      style={{ background: item.status === s.key ? s.color : "transparent", borderColor: s.color, color: item.status === s.key ? "#fff" : s.color }}
                      onClick={() => mutateBoard((b) => { for (const g of b.groups) { const i = g.items.find((x) => x.id === item.id); if (i) i.status = s.key; } return b; })}>
                      {s.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <Info label="ผู้รับผิดชอบ" value={person(item.assignee).name} />
                <Info label="กำหนดส่ง" value={fmt(item.due)} />
                <Info label="เส้นเวลา" value={`${fmt(item.start)} – ${fmt(item.end)}`} />
                <Info label="ความสำคัญ" value={PRIORITY[item.priority]?.label} />
              </div>

              <div>
                <div className="text-xs text-gray-500 mb-1">คอมเมนต์</div>
                <div className="space-y-2">
                  {item.comments?.length ? item.comments.map((c, idx) => (
                    <div key={idx} className="border rounded-xl p-2" style={{ borderColor: pastel.line }}>
                      <div className="text-[11px] text-gray-500">{person(c.by).name} • {new Date(c.at).toLocaleString("th-TH")}</div>
                      <div>{c.text}</div>
                    </div>
                  )) : <div className="text-gray-500 text-sm">— ยังไม่มีคอมเมนต์ —</div>}
                </div>
              </div>

              <div className="flex items-center gap-2 text-gray-600"><Paperclip size={16} /> ไฟล์แนบ {item.files}</div>
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
const Info = ({ label, value }) => (
  <div className="border rounded-xl p-3" style={{ borderColor: pastel.line }}>
    <div className="text-xs text-gray-500 mb-1">{label}</div>
    <div className="font-medium">{value}</div>
  </div>
);

function EmptyState({ title, subtitle }) {
  return (
    <div className="rounded-2xl border p-10 text-center text-gray-600" style={{ background: pastel.panel, borderColor: pastel.line }}>
      <div className="text-lg font-semibold mb-1">{title}</div>
      <div className="text-sm">{subtitle}</div>
    </div>
  );
}

// ──────────────────────────────────────────────────────────────────────────────
// Generate standalone HTML for deployment (one file). Uses CDN React + Tailwind.
function makeStandaloneHTML(state) {
  const escapedState = JSON.stringify(state).replace(/</g, "\\u003c");
  return `<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TPRGS Project Suite – Mockup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>
  <script>
    const state = ${escapedState};
  </script>
  <script>
    const e=React.createElement;
    const fmt=(d)=>new Date(d).toLocaleDateString('th-TH',{day:'2-digit',month:'short'});
    const pastel={brand:'#0ea5e9',accent:'#a78bfa',ok:'#22c55e',bg:'#f9fafb',line:'#e5e7eb'};
    const STATUS=[{key:'todo',label:'ยังไม่เริ่ม',color:'#94a3b8'},{key:'doing',label:'กำลังทำ',color:'#a78bfa'},{key:'review',label:'รอตรวจ',color:'#fb923c'},{key:'done',label:'เสร็จสิ้น',color:'#22c55e'}];
    const PEOPLE=${JSON.stringify(PEOPLE)};
    const person=(id)=>PEOPLE.find(p=>p.id===id)||{name:'ไม่ระบุ'};
    function App(){
      const [s,setS]=React.useState(state);
      const b=s.boards.find(b=>b.id===s.activeBoardId)||s.boards[0];
      return e('div',{className:'max-w-5xl mx-auto p-4 space-y-4'},[
        e('div',{className:'flex items-center justify-between'},[
          e('div',{className:'text-xl font-semibold'},'TPRGS Project Suite – Mockup'),
          e('div',null,[e('button',{className:'px-3 py-1.5 rounded-lg bg-sky-500 text-white',onClick:()=>alert('นี่คือไฟล์ Mockup แบบสแตนด์อโลนสำหรับอัปขึ้นโฮสติ้ง')},'ตัวอย่างสแตนด์อโลน')])
        ]),
        e('div',{className:'rounded-2xl border bg-white'},[
          e('div',{className:'p-4 border-b font-semibold'} ,'บอร์ด: '+b.name),
          e('div',{className:'p-4 overflow-x-auto'},[
            e('table',{className:'min-w-full text-sm'},[
              e('thead',{className:'bg-gray-50'},e('tr',{className:'text-left text-gray-500'},[
                e('th',{className:'px-4 py-2'},'งาน'),
                e('th',{className:'px-4 py-2'},'สถานะ'),
                e('th',{className:'px-4 py-2'},'ผู้รับผิดชอบ'),
                e('th',{className:'px-4 py-2'},'กำหนดส่ง')
              ])),
              e('tbody',null,b.groups.flatMap(g=>g.items).map(it=>e('tr',{key:it.id,className:'border-t'},[
                e('td',{className:'px-4 py-2'},it.title),
                e('td',{className:'px-4 py-2'},STATUS.find(x=>x.key===it.status).label),
                e('td',{className:'px-4 py-2'},person(it.assignee).name),
                e('td',{className:'px-4 py-2'},fmt(it.due))
              ])))
            ])
          ])
        ])
      ])
    }
    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>`;
}
